<div class="stepper-container">
  <!-- Progress indicator -->
  <div class="progress-section">
    <div class="progress-bar">
      <div class="progress-fill" [style.width.%]="progressPercentage"></div>
    </div>
    <p class="progress-text">Paso {{ currentStep + 1 }} de {{ steps.length }}</p>
  </div>

  <!-- Step title -->
  <!-- <h2 class="step-title">{{ currentStepConfig.title }}</h2> -->

  <!-- Info message (si existe) -->
  <div class="info-message" *ngIf="currentStepConfig.infoMessage">
    <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24">
      <path fill="currentColor" d="M11 9h2V7h-2m1 13c-4.41 0-8-3.59-8-8s3.59-8 8-8s8 3.59 8 8s-3.59 8-8 8m0-18A10 10 0 0 0 2 12a10 10 0 0 0 10 10a10 10 0 0 0 10-10A10 10 0 0 0 12 2m-1 15h2v-6h-2z"/>
    </svg>
    <p>{{ currentStepConfig.infoMessage }}</p>
  </div>

  <!-- Tabs de nacionalidad (solo si hay campo de nacionalidad) -->
  <div class="dni-tabs-section" *ngIf="hasNacionalidadField()">
    <app-tab-dni
      (typeDNIEmitter)="onNacionalidadChange($event)"
    ></app-tab-dni>
  </div>

  <!-- Form content -->
  <div class="form-content" [class.with-keyboard]="useVirtualKeyboard">
    <form [formGroup]="stepForm" class="step-form">
      <div 
        *ngFor="let field of currentStepConfig.fields" 
        class="form-field-wrapper"
        [class.hidden-field]="field.name === 'nacionalidad'"
        (click)="setActiveField(field.name)"
      >
        <label [for]="field.name" class="field-label">
          {{ field.label }}
          <button 
            *ngIf="field.infoText"
            type="button"
            class="field-info-button-inline" 
            (click)="toggleInfo(field.name, $event)"
            [attr.aria-label]="'Información sobre ' + field.label"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24">
              <path fill="currentColor" d="M11 9h2V7h-2m1 13c-4.41 0-8-3.59-8-8s3.59-8 8-8s8 3.59 8 8s-3.59 8-8 8m0-18A10 10 0 0 0 2 12a10 10 0 0 0 10 10a10 10 0 0 0 10-10A10 10 0 0 0 12 2m-1 15h2v-6h-2z"/>
            </svg>
          </button>
        </label>

        <!-- Input container con prefijo (estilo punto de venta) -->
        <span class="input-container" [class.input-focused]="activeFieldName === field.name">
          <span *ngIf="field.prefix || field.name === 'cedula'" class="input-prefix">
            {{ field.prefix || (stepForm.get('nacionalidad')?.value || 'V') }}
          </span>
          
          <!-- Custom Select -->
          <app-custom-select
            *ngIf="field.type === 'select' && field.name !== 'nacionalidad'"
            [id]="field.name"
            [formControlName]="field.name"
            [options]="field.options || []"
            [placeholder]="'Seleccione...'"
            (focus)="setActiveField(field.name)"
          ></app-custom-select>

          <!-- Input text/tel/number -->
          <input 
            *ngIf="field.type !== 'select'"
            [id]="field.name"
            [type]="field.type"
            [formControlName]="field.name"
            [placeholder]="field.placeholder || ''"
            [attr.maxlength]="field.maxLength || null"
            class="form-input"
            (focus)="setActiveField(field.name); useVirtualKeyboard && preventNativeKeyboard($event)"
            (click)="useVirtualKeyboard && preventNativeKeyboard($event)"
            (input)="onInputChange($event, field.name)"
            [readonly]="useVirtualKeyboard && field.type === 'tel'"
            #activeInput
          />
        </span>

        <!-- Error messages -->
        <div class="field-errors" *ngIf="stepForm.get(field.name)?.invalid && stepForm.get(field.name)?.touched">
          <small *ngIf="stepForm.get(field.name)?.errors?.['required']">
            Este campo es requerido
          </small>
          <small *ngIf="stepForm.get(field.name)?.errors?.['minlength']">
            Mínimo {{ field.minLength }} caracteres
          </small>
          <small *ngIf="stepForm.get(field.name)?.errors?.['maxlength']">
            Máximo {{ field.maxLength }} caracteres
          </small>
          <small *ngIf="stepForm.get(field.name)?.errors?.['pattern']">
            Formato inválido
          </small>
        </div>

        <!-- Info popover -->
        <div 
          class="field-info-popover" 
          *ngIf="showInfoPopover === field.name"
          (click)="$event.stopPropagation()"
        >
          <button 
            type="button"
            class="close-popover" 
            (click)="showInfoPopover = null"
            aria-label="Cerrar información"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24">
              <path fill="currentColor" d="M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12z"/>
            </svg>
          </button>
          <p>{{ field.infoText }}</p>
        </div>
      </div>
    </form>

    <!-- Virtual keyboard (si está habilitado) - STICKY -->
    <div class="virtual-keyboard-section" *ngIf="useVirtualKeyboard">
      <app-keyboard-on-screen
        classes="pinpad-big-size"
        (valorTeclado)="onVirtualKeyboardInput($event)"
        (deleteKeyEmitter)="onVirtualKeyboardDelete()"
      ></app-keyboard-on-screen>
    </div>
  </div>

  <!-- Navigation buttons -->
  <div class="navigation-buttons">
    <button 
      type="button"
      class="nav-button prev-button" 
      (click)="previousStep()"
      [disabled]="isFirstStep"
      *ngIf="!isFirstStep"
    >
      <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24">
        <path fill="currentColor" d="M15.41 7.41L14 6l-6 6l6 6l1.41-1.41L10.83 12z"/>
      </svg>
      Anterior
    </button>

    <button 
      type="button"
      class="nav-button next-button" 
      (click)="nextStep()"
      [disabled]="stepForm.invalid"
    >
      {{ isLastStep ? 'Finalizar' : 'Siguiente' }}
      <svg *ngIf="!isLastStep" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24">
        <path fill="currentColor" d="M8.59 16.59L13.17 12L8.59 7.41L10 6l6 6l-6 6z"/>
      </svg>
      <svg *ngIf="isLastStep" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24">
        <path fill="currentColor" d="M9 16.17L4.83 12l-1.42 1.41L9 19L21 7l-1.41-1.41z"/>
      </svg>
    </button>
  </div>
</div>